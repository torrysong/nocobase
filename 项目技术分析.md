# NocoBase 项目技术分析

## 一、技术栈

### 1.1 前端技术
- **React 18** - UI框架
- **TypeScript** - 类型系统
- **Ant Design 5** - UI组件库
- **Formily 2.x** - 表单和Schema驱动框架
  - `@formily/react` - React绑定
  - `@formily/antd-v5` - Ant Design集成
  - `@formily/json-schema` - JSON Schema支持
- **React Router 6** - 路由管理
- **@dnd-kit** - 拖拽排序
- **i18next** - 国际化
- **Emotion CSS** - CSS-in-JS样式方案

### 1.2 后端技术
- **Node.js 18+** - 运行环境
- **Sequelize 6.x** - ORM框架
- **Express/Koa** - Web框架（通过@nocobase/server）
- **Joi** - 数据验证
- **Umzug** - 数据库迁移工具

### 1.3 数据库支持
- PostgreSQL
- MySQL
- MariaDB

### 1.4 构建和工具
- **Monorepo架构** - 使用Lerna管理多包
- **Yarn Workspaces** - 包管理
- **TypeScript** - 类型检查
- **Vitest** - 测试框架

## 二、核心设计模式

### 2.1 插件化架构（Plugin-based Architecture）
- **类似WordPress的插件系统**
- 所有功能都是插件，包括核心功能
- 插件可以独立安装、卸载、启用、禁用
- 插件之间可以相互依赖和扩展

**核心目录结构：**
```
packages/
  ├── core/          # 核心模块
  │   ├── client/    # 前端核心
  │   ├── database/  # 数据库核心
  │   ├── server/    # 服务端核心
  │   └── ...
  └── plugins/       # 插件目录
      └── @nocobase/
          ├── plugin-client/
          ├── plugin-data-source-main/
          ├── plugin-ui-schema-storage/
          └── ...
```

### 2.2 Schema驱动设计（Schema-Driven）
- **基于JSON Schema的配置化开发**
- 页面结构、表单、表格都通过Schema定义
- Schema存储在数据库中（uiSchemas表）
- 支持Schema的增删改查和版本管理

**Schema示例：**
```json
{
  "type": "void",
  "name": "page",
  "x-component": "Page",
  "properties": {
    "block1": {
      "type": "void",
      "x-component": "Grid",
      "x-initializer": "page:addBlock"
    }
  }
}
```

### 2.3 数据模型驱动（Model-Driven）
- **数据结构和UI完全解耦**
- 同一个数据表可以创建多个不同的UI展示
- 支持主数据库、外部数据库、第三方API作为数据源
- Collection（数据集合）和Field（字段）系统

### 2.4 UI Schema存储机制
- **页面配置存储在数据库中**
- 支持Schema的嵌套、继承、合并
- 提供Schema的CRUD操作API
- 支持Schema模板和版本管理

## 三、页面编辑实现机制

### 3.1 UI Schema存储系统

**核心文件：**
- `packages/plugins/@nocobase/plugin-ui-schema-storage/` - UI Schema存储插件
- `packages/core/client/src/schema-component/` - Schema组件系统

**实现原理：**

1. **Schema存储**
   - 页面结构以JSON Schema形式存储在`uiSchemas`表中
   - 每个Schema节点有唯一的`x-uid`
   - 支持Schema的树形结构（父子关系）

2. **Schema组件渲染**
   ```typescript
   // packages/core/client/src/schema-component/antd/page/Page.tsx
   <RemoteSchemaComponent
     uid={schemaUid}
     schemaTransform={transformMultiColumnToSingleColumn}
   />
   ```

3. **可设计模式（Designable）**
   - 通过`useDesignable` Hook启用编辑模式
   - 支持拖拽、插入、删除、移动Schema节点
   - 实时预览编辑效果

4. **Schema操作API**
   ```typescript
   // packages/plugins/@nocobase/plugin-ui-schema-storage/src/server/actions/ui-schema-action.ts
   uiSchemaActions = {
     getJsonSchema,      // 获取Schema
     insert,             // 插入节点
     remove,             // 删除节点
     patch,              // 更新节点
     insertAdjacent,     // 相邻位置插入
     insertBeforeBegin,  // 在开始前插入
     insertAfterBegin,   // 在开始后插入
     insertBeforeEnd,    // 在结束前插入
     insertAfterEnd,     // 在结束后插入
   }
   ```

### 3.2 页面样式编辑

**实现方式：**
1. **Schema属性配置**
   - 通过Schema的`x-component-props`配置组件属性
   - 支持样式、布局、主题等配置

2. **主题编辑器**
   - `plugin-theme-editor` - 主题编辑插件
   - 支持全局主题配置
   - 支持CSS变量和主题变量

3. **组件样式定制**
   - 通过`x-decorator-props`配置装饰器样式
   - 通过`x-component-props`配置组件样式
   - 支持响应式布局配置

### 3.3 拖拽编辑

**技术实现：**
- 使用`@dnd-kit`实现拖拽功能
- `SortableItem`组件包装可拖拽元素
- `DndContext`提供拖拽上下文
- 拖拽结束后更新Schema结构

## 四、数据库编辑和绑定机制

### 4.1 Collection（数据集合）系统

**核心文件：**
- `packages/core/database/src/collection.ts` - Collection类
- `packages/core/data-source-manager/src/collection-manager.ts` - Collection管理器

**Collection定义：**
```typescript
// Collection代表一个数据表
const collection = db.defineCollection({
  name: 'users',
  title: '用户',
  fields: [
    {
      name: 'name',
      type: 'string',
      title: '姓名'
    },
    {
      name: 'email',
      type: 'string',
      title: '邮箱'
    }
  ]
});
```

**Collection功能：**
- 字段管理（addField, removeField, updateField）
- 关联关系定义（belongsTo, hasMany, hasOne, manyToMany）
- 索引管理
- 数据验证
- 数据库同步

### 4.2 Field（字段）系统

**字段类型：**
- 基础类型：string, number, boolean, date, json等
- 关联类型：belongsTo, hasMany, hasOne, manyToMany
- 特殊类型：formula, sequence, sort等

**字段定义：**
```typescript
collection.addField('name', {
  type: 'string',
  title: '姓名',
  required: true,
  validation: {
    rules: [
      { name: 'required' },
      { min: 2, max: 50 }
    ]
  }
});
```

### 4.3 数据块绑定（Block Provider）

**核心文件：**
- `packages/core/client/src/schema-component/antd/page/AllDataBlocksProvider.tsx`
- `packages/core/client/src/filter-provider/FilterProvider.tsx`

**实现原理：**

1. **DataBlock注册**
   ```typescript
   // 数据块提供者注册数据块信息
   const block = {
     uid: 'block-1',
     collection: 'users',
     dataSource: 'main',
     service: useRequest(...)
   };
   recordDataBlocks(block);
   ```

2. **数据块提供者（BlockProvider）**
   - 每个数据块组件都包装在BlockProvider中
   - BlockProvider提供数据查询、过滤、分页等功能
   - 支持数据块之间的关联和联动

3. **数据绑定流程**
   ```
   Schema定义 → Block组件 → BlockProvider → Collection → Database
   ```

### 4.4 页面与数据库关联

**关联方式：**

1. **通过Schema配置绑定**
   ```json
   {
     "x-component": "Table",
     "x-decorator": "TableBlockProvider",
     "x-decorator-props": {
       "collection": "users",
       "dataSource": "main"
     }
   }
   ```

2. **数据源管理**
   - `plugin-data-source-manager` - 数据源管理插件
   - 支持多个数据源（主数据库、外部数据库、API）
   - 每个数据源有独立的Collection管理

3. **字段绑定**
   ```json
   {
     "x-component": "Input",
     "x-decorator": "FormItem",
     "name": "name",  // 绑定Collection字段
     "x-component-props": {
       "placeholder": "请输入姓名"
     }
   }
   ```

### 4.5 数据库编辑界面

**实现位置：**
- `plugin-data-source-main` - 主数据源插件
- 提供Collection和Field的可视化编辑界面
- 支持字段类型选择、验证规则配置、关联关系设置

**编辑流程：**
1. 创建/编辑Collection
2. 添加/编辑Field
3. 配置字段属性（类型、验证、关联等）
4. 同步到数据库（通过Sequelize）

## 五、核心工作流程

### 5.1 页面创建流程
```
1. 用户创建页面 → 生成基础Schema
2. 添加Block → 插入Schema节点
3. 配置Block → 设置x-decorator-props绑定Collection
4. 配置字段 → 设置字段Schema绑定Field
5. 保存 → 存储Schema到uiSchemas表
6. 渲染 → RemoteSchemaComponent读取并渲染
```

### 5.2 数据绑定流程
```
1. 定义Collection → 创建数据表结构
2. 创建Block → 选择Collection
3. BlockProvider → 提供数据查询服务
4. 字段绑定 → Schema name对应Field name
5. 数据展示 → 组件渲染数据
```

### 5.3 Schema更新流程
```
1. 用户编辑 → 调用Schema API
2. 更新Schema → patch/insert/remove操作
3. 清除缓存 → 清除Schema缓存
4. 重新渲染 → RemoteSchemaComponent重新加载
```

## 六、关键技术点

### 6.1 Schema Component系统
- 基于Formily的Schema驱动渲染
- 支持组件注册和扩展
- 支持装饰器模式（Decorator）
- 支持Schema继承和合并

### 6.2 数据查询系统
- 基于Sequelize的ORM查询
- 支持关联查询（include）
- 支持过滤、排序、分页
- 支持游标分页（Cursor-based Pagination）

### 6.3 权限控制（ACL）
- 基于角色的访问控制
- Collection级别权限
- Field级别权限
- Action级别权限

### 6.4 国际化（i18n）
- 基于i18next的多语言支持
- Schema标题和描述支持翻译
- 字段标签支持翻译

## 七、总结

NocoBase采用了**Schema驱动 + 插件化 + 数据模型驱动**的架构设计：

1. **页面编辑**：通过UI Schema存储页面结构，支持可视化编辑和拖拽
2. **数据库编辑**：通过Collection和Field系统管理数据结构
3. **数据绑定**：通过BlockProvider和Schema配置实现页面与数据的关联
4. **扩展性**：插件化架构支持无限扩展

这种设计使得NocoBase既能满足无代码用户的需求，又能支持低代码开发者的扩展需求。

